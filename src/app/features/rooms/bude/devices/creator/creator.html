<div class="device creator">
  <div class="header">
    <button class="back-button" (click)="onBackClick()">â† ZurÃ¼ck</button>
    <h2>PC Befehle (Creator)</h2>
    <button
      class="filter-button"
      [class.active]="showOnlyBookmarked"
      (click)="toggleBookmarkFilter(); $event.stopPropagation()"
      title="Nur gebookmarkte Befehle anzeigen">
      {{ showOnlyBookmarked ? 'â­ Nur Favoriten' : 'â˜† Alle Befehle' }}
    </button>
  </div>

  <!-- Lade-Anzeige -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Lade PC-Befehle von Home Assistant...</p>
  </div>

  <!-- Fehler-Anzeige -->
  <div *ngIf="loadError && !loading" class="error-container">
    <h3>âš ï¸ Fehler</h3>
    <p>{{ loadError }}</p>
    <button class="retry-button" (click)="ngOnInit()">ğŸ”„ Erneut versuchen</button>
  </div>

  <!-- Befehls-Tabelle -->
  <div *ngIf="!loading && !loadError" class="commands-table-container">
    <div class="stats">
      <span>ğŸ“Š Gesamt: {{ commands.length }} Befehle</span>
      <span *ngIf="showOnlyBookmarked">â­ Favoriten: {{ filteredCommands.length }}</span>
    </div>

    <table class="commands-table">
      <thead>
        <tr>
          <th>Entity ID</th>
          <th>Beschreibung</th>
          <th>Aktueller Status</th>
          <th>Aktion</th>
          <th>Test-Status</th>
          <th>Favorit</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cmd of filteredCommands"
            [class.bookmarked]="cmd.bookmarked"
            [class.sensor-row]="cmd.service === 'none'">
          <td class="command-name" [title]="cmd.entityId || cmd.command">
            {{ cmd.entityId || cmd.command }}
          </td>
          <td class="command-description">{{ cmd.description }}</td>
          <td class="command-current-state">
            <span class="state-badge" [class.state-on]="cmd.currentState === 'on'"
                                       [class.state-off]="cmd.currentState === 'off'">
              {{ cmd.currentState || 'â€”' }}
            </span>
          </td>
          <td class="command-action">
            <button
              *ngIf="cmd.service !== 'none'"
              class="execute-button"
              [disabled]="testingCommand === cmd.command"
              (click)="executeCommand(cmd); $event.stopPropagation()">
              {{ testingCommand === cmd.command ? 'â³ LÃ¤uft...' : 'â–¶ AusfÃ¼hren' }}
            </button>
            <span *ngIf="cmd.service === 'none'" class="read-only-label">ğŸ“– Nur lesen</span>
          </td>
          <td class="command-status">
            <span *ngIf="!cmd.tested" class="status-icon untested">â€”</span>
            <span *ngIf="cmd.tested && cmd.testSuccess" class="status-icon success" title="Test erfolgreich">âœ“</span>
            <span *ngIf="cmd.tested && !cmd.testSuccess" class="status-icon failure" title="Test fehlgeschlagen">âœ—</span>
          </td>
          <td class="command-bookmark">
            <input
              type="checkbox"
              [checked]="cmd.bookmarked"
              (change)="toggleBookmark(cmd); $event.stopPropagation(); $event.preventDefault()"
              title="Als Favorit markieren">
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="filteredCommands.length === 0" class="no-commands">
      <p>{{ showOnlyBookmarked ? 'â­ Keine Favoriten markiert. Markiere Befehle als Favoriten.' : 'âŒ Keine Befehle gefunden.' }}</p>
    </div>
  </div>

  <div *ngIf="!loading && !loadError" class="info-panel">
    <h3>â„¹ï¸ Hinweise</h3>
    <ul>
      <li><strong>PC:</strong> Nur Entities von CREATOR-Z590-P1 werden angezeigt</li>
      <li><strong>HASS.Agent:</strong> Stelle sicher, dass HASS.Agent auf dem PC lÃ¤uft und mit Home Assistant verbunden ist</li>
      <li><strong>MQTT:</strong> Mosquitto Broker muss laufen und in Home Assistant konfiguriert sein</li>
      <li><strong>Live-Status:</strong> Der aktuelle Status wird in Echtzeit Ã¼ber WebSocket aktualisiert</li>
      <li><strong>Sensoren:</strong> Sensor-Entities sind nur lesbar und kÃ¶nnen nicht ausgefÃ¼hrt werden</li>
      <li><strong>Favoriten:</strong> Werden lokal im Browser gespeichert</li>
      <li><strong>Spy-Script:</strong> Beim AusfÃ¼hren von "Starte Spy" wird ein Live-Screenshot-Dialog geÃ¶ffnet</li>
    </ul>
  </div>

  <!-- Spy-Screenshot Dialog -->
  <div *ngIf="showSpyDialog" class="spy-dialog-overlay" (click)="closeSpyDialog()">
    <div class="spy-dialog" (click)="$event.stopPropagation()">
      <div class="spy-dialog-header">
        <h3>ğŸ” Live PC-Screenshot</h3>
        <button class="close-button" (click)="closeSpyDialog()" title="SchlieÃŸen und Spy stoppen">âœ•</button>
      </div>
      <div class="spy-dialog-content">
        <!-- Debug Info - FESTE HÃ–HE -->
        <div class="debug-info" style="color: #fff; background: rgba(0,0,0,0.5); padding: 1rem; border-radius: 4px; margin-bottom: 1rem; font-family: monospace; font-size: 0.85rem; max-width: 100%; overflow-wrap: break-word; width: 100%; flex-shrink: 0; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
          <div><strong>Status:</strong> {{ imageLoadStatus }}</div>
          <div *ngIf="imageErrorMessage" style="color: #ff6b6b; margin-top: 0.5rem;"><strong>âŒ Fehler:</strong> {{ imageErrorMessage }}</div>
        </div>

        <img
          [src]="spyScreenshotUrl"
          alt="PC Screenshot"
          class="spy-screenshot"
          (load)="onImageLoad()"
          (error)="onImageError($event)">

        <div class="spy-info">
          <span class="refresh-indicator">ğŸ”„ Aktualisiert alle {{timeout}}ms</span>
          <span class="timestamp">{{ imageLoadStatus }}</span>
        </div>
      </div>
      <div class="spy-dialog-footer">
        <button class="stop-spy-button" (click)="closeSpyDialog()">
          ğŸ›‘ Spy stoppen und schlieÃŸen
        </button>
      </div>
    </div>
  </div>
</div>
